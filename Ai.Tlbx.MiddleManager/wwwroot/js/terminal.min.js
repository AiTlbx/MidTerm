"use strict";(()=>{var xn=Object.defineProperty;var S=(e,t)=>()=>(e&&(t=e(e=0)),t);var pt=(e,t)=>{for(var n in t)xn(e,n,{get:t[n],enumerable:!0})};var x,X,re,O=S(()=>{"use strict";x={dark:{background:"#16161E",foreground:"#C0CAF5",cursor:"#C0CAF5",cursorAccent:"#16161E",selectionBackground:"#283457"},light:{background:"#D5D6DB",foreground:"#343B58",cursor:"#343B58",cursorAccent:"#D5D6DB",selectionBackground:"#9FA0A5"},solarizedDark:{background:"#002B36",foreground:"#839496",cursor:"#839496",cursorAccent:"#002B36",selectionBackground:"#073642"},solarizedLight:{background:"#FDF6E3",foreground:"#657B83",cursor:"#657B83",cursorAccent:"#FDF6E3",selectionBackground:"#EEE8D5"}},X=1e3,re=3e4});function ft(e){d=e}function J(e){c=e}function Le(e){u=e}function me(e){w=e}function gt(e){T=e}function ke(e){P=e}function Me(e){ae=e}function pe(e){En=e}function ht(e){wn=e}function vt(e){le=e}function Ae(e){ce=e}function Be(e){z=e}function St(e){A=e}function yt(e){de=e}function Ie(e){Y=e}function Re(e){H=e}function fe(e){G=e}function bt(e){ue=e}function xt(){r.sessionList=document.getElementById("session-list"),r.sessionCount=document.getElementById("session-count"),r.terminalsArea=document.querySelector(".terminals-area"),r.emptyState=document.getElementById("empty-state"),r.mobileTitle=document.getElementById("mobile-title"),r.topbarActions=document.getElementById("topbar-actions"),r.app=document.getElementById("app"),r.sidebarOverlay=document.getElementById("sidebar-overlay"),r.settingsView=document.getElementById("settings-view"),r.settingsBtn=document.getElementById("btn-settings"),r.islandTitle=document.getElementById("island-title")}var d,c,u,w,T,P,ae,En,wn,le,ce,z,A,de,Y,H,ue,m,V,N,C,G,r,h=S(()=>{"use strict";d=[],c=null,u=null,w=null,T=null,P=!1,ae=!1,En=!1,wn=null,ce=1e3,z=!1,A=null,Y=1e3,H=!1,ue=null,m=new Map,V=new Set,N=new Set,C=new Map,G=null,r={sessionList:null,sessionCount:null,terminalsArea:null,emptyState:null,mobileTitle:null,topbarActions:null,app:null,sidebarOverlay:null,settingsView:null,settingsBtn:null,islandTitle:null}});function B(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function f(e,t){let n=document.getElementById(e);n&&n.addEventListener("click",t)}function Et(e,t){let n;return(...o)=>{n!==void 0&&clearTimeout(n),n=window.setTimeout(()=>e(...o),t)}}var wt=S(()=>{"use strict"});function Pe(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):null}function D(e,t,n=365){let o=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${e}=${encodeURIComponent(t)}; expires=${o}; path=/`}function Tt(e){if(e!=="auto")return e;let t=navigator.userAgent||"";return/Windows|Win32|Win64/i.test(t)?"windows":"unix"}var Ct=S(()=>{"use strict"});var L=S(()=>{"use strict";wt();Ct()});function De(e){e.sendResize&&(Ft=e.sendResize)}function Q(e){let t=m.get(e);if(!t)return;if(!t.opened){(G??Promise.resolve()).then(()=>{Q(e)});return}let n=t.container.querySelector(".xterm");n&&(n.style.zoom="",n.style.transform="",t.container.classList.remove("scaled"));let o=t.container.classList.contains("hidden");o&&t.container.classList.remove("hidden"),requestAnimationFrame(()=>{t.fitAddon.fit(),Ft(e,t.terminal),o&&t.container.classList.add("hidden")})}function I(e,t){let n=t.container,o=n.querySelector(".xterm");o&&requestAnimationFrame(()=>{let i=n.clientWidth-8,s=n.clientHeight-8,l=o.offsetWidth,a=o.offsetHeight,p=i/l,g=s/a,v=Math.min(p,g,1);v<.99?(o.style.zoom=v,o.style.transform="",n.classList.add("scaled")):(o.style.zoom="",o.style.transform="",n.classList.remove("scaled"))})}function Ue(){window.addEventListener("resize",Et(()=>{m.forEach((e,t)=>{e.opened&&I(t,e)})},100))}function We(){if(!window.visualViewport||!r.terminalsArea)return;let e=0,t=()=>{let n=window.visualViewport.height;if(Math.abs(n-e)<1)return;e=n,document.documentElement.style.setProperty("--visual-vh",n+"px");let o=document.querySelector(".mobile-header"),i=0;o&&window.getComputedStyle(o).display!=="none"&&(i=o.offsetHeight);let s=Math.floor((n-i)*.99);r.terminalsArea.style.height=s+"px"};window.visualViewport.addEventListener("resize",t),t()}var Ft,Fe=S(()=>{"use strict";h();L();Ft=()=>{}});function ze(e,t){try{let n=new SearchAddon.SearchAddon;t.loadAddon(n),te.set(e,{addon:n,currentIndex:0,totalMatches:0})}catch{}}function Hn(e){te.delete(e)}function Ve(){q||(q=document.getElementById("terminal-search"),R=document.getElementById("search-input"),M=document.getElementById("search-results")),q&&R&&(q.classList.remove("hidden"),Oe=!0,R.focus(),R.select())}function ee(){if(q&&(q.classList.add("hidden"),Oe=!1),c){let e=te.get(c);e?.addon&&e.addon.clearDecorations()}if(c){let e=m.get(c);e&&e.terminal.focus()}}function qe(){return Oe}function ve(){if(!c||!R)return;let e=R.value;if(!e)return;let t=te.get(c);if(!t?.addon)return;let n=t.addon.findNext(e,{incremental:!1});_t(n)}function _e(){if(!c||!R)return;let e=R.value;if(!e)return;let t=te.get(c);if(!t?.addon)return;let n=t.addon.findPrevious(e);_t(n)}function _t(e){M&&(e?(M.textContent="Found",M.style.color=""):(M.textContent="No matches",M.style.color="var(--accent-red)"))}function Ke(){let e=document.getElementById("search-input"),t=document.getElementById("search-prev"),n=document.getElementById("search-next"),o=document.getElementById("search-close");e&&(e.addEventListener("input",()=>{c&&e.value?ve():M&&(M.textContent="0/0",M.style.color="")}),e.addEventListener("keydown",i=>{i.key==="Enter"?(i.preventDefault(),i.shiftKey?_e():ve()):i.key==="Escape"&&(i.preventDefault(),ee())})),t&&t.addEventListener("click",_e),n&&n.addEventListener("click",ve),o&&o.addEventListener("click",ee)}var te,Oe,R,M,q,$e=S(()=>{"use strict";h();te=new Map,Oe=!1,R=null,M=null,q=null});function Nn(e,t){if(d.find(s=>s.id===e)?.manuallyNamed)return;let o=je.get(e);o&&window.clearTimeout(o);let i=window.setTimeout(()=>{je.delete(e),fetch(`/api/sessions/${e}/name?auto=true`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).catch(()=>{})},500);je.set(e,i)}function Xe(e){e.sendInput&&(K=e.sendInput),e.showBellNotification&&(Ot=e.showBellNotification)}function Ye(){let e=window.innerWidth<=768,t=u?.fontSize??14,n=e?Math.max(t-2,10):t,o=u?.theme??"dark",i=u?.fontFamily??"Cascadia Code",s={cursorBlink:u?.cursorBlink??!0,cursorStyle:u?.cursorStyle??"bar",fontFamily:`'${i}', 'Cascadia Mono', Consolas, 'Courier New', monospace`,fontSize:n,letterSpacing:0,lineHeight:1,scrollback:u?.scrollbackLines??1e4,minimumContrastRatio:u?.minimumContrastRatio??1,smoothScrollDuration:u?.smoothScrolling?150:0,allowProposedApi:!0,customGlyphs:!0,rescaleOverlappingGlyphs:!0,theme:x[o]??x.dark};return ue!==null&&(s.windowsPty={backend:"conpty",buildNumber:ue}),s}function Ge(e,t){let n=m.get(e);if(n)return n;let o=document.createElement("div");o.className="terminal-container hidden",o.id="terminal-"+e,r.terminalsArea?.appendChild(o);let i=new Terminal(Ye()),s=new FitAddon.FitAddon;i.loadAddon(s);let l=t&&t.cols>0?t.cols:0,a=t&&t.rows>0?t.rows:0,p={terminal:i,fitAddon:s,container:o,serverCols:l,serverRows:a,opened:!1};return m.set(e,p),(G??Promise.resolve()).then(()=>{if(m.has(e)){if(i.open(o),p.opened=!0,u?.useWebGL!==!1)try{let g=new WebglAddon.WebglAddon;g.onContextLost(()=>{g.dispose()}),i.loadAddon(g)}catch{}try{let g=new WebLinksAddon.WebLinksAddon((v,_)=>{(_.startsWith("http://")||_.startsWith("https://"))&&window.open(_,"_blank","noopener,noreferrer")});i.loadAddon(g)}catch{}ze(e,i),Dn(e,p),requestAnimationFrame(()=>{m.has(e)&&(p.serverCols>0&&p.serverRows>0&&(i.resize(p.serverCols,p.serverRows),I(e,p)),Vt(e,i,o))})}}),p}function Dn(e,t){let n=C.get(e);n&&n.length>0&&(n.forEach(o=>{zt(e,t,o)}),C.delete(e))}function zt(e,t,n){let o=n[0]|n[1]<<8,i=n[2]|n[3]<<8,s=n.slice(4);if(o>0&&o<=500&&i>0&&i<=500&&t.terminal._core&&t.terminal._core._renderService){let a=t.terminal.cols,p=t.terminal.rows;if(a!==o||p!==i)try{t.terminal.resize(o,i),t.serverCols=o,t.serverRows=i,I(e,t)}catch{}}s.length>0&&t.terminal.write(s)}function Vt(e,t,n){t.onData(s=>{K(e,s)}),t.onBell(()=>{Ot(e)}),t.onSelectionChange(()=>{u?.copyOnSelect&&t.hasSelection()&&navigator.clipboard.writeText(t.getSelection()).catch(()=>{})}),t.onTitleChange(s=>{s&&s.trim()&&Nn(e,s.trim())}),t.attachCustomKeyEventHandler(s=>{if(s.type!=="keydown")return!0;if(s.ctrlKey&&!s.shiftKey&&!s.altKey&&!s.metaKey&&s.key==="Enter")return K(e,`
`),!1;if(Tt(u?.clipboardShortcuts??"auto")==="windows"){if(s.ctrlKey&&!s.shiftKey&&s.key==="c")return t.hasSelection()?(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection(),!1):!0;if(s.ctrlKey&&!s.shiftKey&&s.key==="v")return navigator.clipboard.readText().then(a=>{a&&K(e,a)}).catch(()=>{}),!1}else{if(s.ctrlKey&&s.shiftKey&&(s.key==="C"||s.key==="c"))return t.hasSelection()&&(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection()),!1;if(s.ctrlKey&&s.shiftKey&&(s.key==="V"||s.key==="v"))return navigator.clipboard.readText().then(a=>{a&&K(e,a)}).catch(()=>{}),!1}return(s.ctrlKey||s.metaKey)&&s.key==="f"?(Ve(),!1):s.key==="Escape"&&qe()?(ee(),!1):!0});let o=s=>{(!u||u.rightClickPaste!==!1)&&(s.preventDefault(),navigator.clipboard.readText().then(l=>{l&&K(e,l)}).catch(()=>{}))};n.addEventListener("contextmenu",o);let i=m.get(e);i&&(i.contextMenuHandler=o)}function Se(e){let t=m.get(e);t&&(t.contextMenuHandler&&t.container.removeEventListener("contextmenu",t.contextMenuHandler),t.terminal.dispose(),t.container.remove(),m.delete(e),C.delete(e))}function Un(){let e=Ye();m.forEach(t=>{t.terminal.options.cursorBlink=e.cursorBlink,t.terminal.options.cursorStyle=e.cursorStyle,t.terminal.options.fontSize=e.fontSize,t.terminal.options.theme=e.theme})}function qt(e,t){fetch("/api/sessions/"+e+"/buffer").then(n=>n.ok?n.text():"").then(n=>{n&&t.write(n)}).catch(n=>{console.error("Error fetching buffer:",n)})}function ye(){if(!c)return;let e=m.get(c);e&&e.opened&&(e.terminal.clear(),qt(c,e.terminal))}function Je(){let e=document.fonts.ready.then(()=>{let t=document.createElement("span");return t.style.fontFamily="'Cascadia Code', 'Cascadia Mono', Consolas, monospace",t.style.position="absolute",t.style.left="-9999px",t.textContent="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",document.body.appendChild(t),new Promise(n=>{requestAnimationFrame(()=>{t.remove(),n()})})});return fe(e),e}var K,Ot,je,Kt=S(()=>{"use strict";O();h();L();Fe();$e();K=()=>{},Ot=()=>{},je=new Map});var $t={};pt($t,{applySettingsToTerminals:()=>Un,applyTerminalScaling:()=>I,bindSearchEvents:()=>Ke,cleanupSearchForTerminal:()=>Hn,createTerminalForSession:()=>Ge,destroyTerminalForSession:()=>Se,fetchAndWriteBuffer:()=>qt,findNext:()=>ve,findPrevious:()=>_e,fitSessionToScreen:()=>Q,getTerminalOptions:()=>Ye,hideSearch:()=>ee,initSearchForTerminal:()=>ze,isSearchVisible:()=>qe,preloadTerminalFont:()=>Je,refreshActiveTerminalBuffer:()=>ye,registerScalingCallbacks:()=>De,registerTerminalCallbacks:()=>Xe,setupResizeObserver:()=>Ue,setupTerminalEvents:()=>Vt,setupVisualViewport:()=>We,showSearch:()=>Ve,writeOutputFrame:()=>zt});var Ze=S(()=>{"use strict";Kt();Fe();$e()});function y(e,t){let n=document.getElementById(e);n&&(n.value=String(t))}function W(e,t){let n=document.getElementById(e);n&&(n.checked=t)}function b(e,t){let n=document.getElementById(e);return n?n.value:t}function F(e){let t=document.getElementById(e);return t?t.checked:!1}function nn(e){let t=document.getElementById("version-web");if(t&&e){let n=e.split(/[+-]/)[0].split(".").slice(0,3).join(".");t.textContent="v"+n}}function on(e,t){let n=document.getElementById("setting-run-as-user");n&&(n.innerHTML='<option value="">Process Owner (default)</option>',e.forEach(o=>{let i=document.createElement("option");i.value=o.username,i.textContent=o.username,o.username===t&&(i.selected=!0),n.appendChild(i)}))}function sn(e){y("setting-default-shell",e.defaultShell||"Pwsh"),y("setting-working-dir",e.defaultWorkingDirectory||""),y("setting-font-size",e.fontSize||14),y("setting-font-family",e.fontFamily||"Cascadia Code"),y("setting-cursor-style",e.cursorStyle||"bar"),W("setting-cursor-blink",e.cursorBlink!==!1),y("setting-theme",e.theme||"dark"),y("setting-contrast",String(e.minimumContrastRatio||1)),y("setting-scrollback",e.scrollbackLines||1e4),y("setting-bell-style",e.bellStyle||"notification"),W("setting-copy-on-select",e.copyOnSelect===!0),W("setting-right-click-paste",e.rightClickPaste!==!1),y("setting-clipboard-shortcuts",e.clipboardShortcuts||"auto"),W("setting-smooth-scrolling",e.smoothScrolling===!0),W("setting-webgl",e.useWebGL!==!1),y("setting-run-as-user",e.runAsUser||""),W("setting-debug-logging",e.debugLogging===!0)}async function ne(){try{let[e,t,n]=await Promise.all([fetch("/api/settings").then(o=>o.json()),fetch("/api/users").then(o=>o.json()).catch(()=>[]),fetch("/api/version").then(o=>o.text()).catch(()=>null)]);Le(e),on(t,e.runAsUser),sn(e),nn(n),rn()}catch(e){console.error("Error fetching settings:",e)}}function rn(){if(!u)return;let e=x[u.theme]||x.dark,t=`'${u.fontFamily||"Cascadia Code"}', 'Cascadia Mono', Consolas, 'Courier New', monospace`;m.forEach(n=>{n.terminal.options.cursorBlink=u.cursorBlink,n.terminal.options.cursorStyle=u.cursorStyle,n.terminal.options.fontFamily=t,n.terminal.options.fontSize=u.fontSize,n.terminal.options.theme=e,n.terminal.options.minimumContrastRatio=u.minimumContrastRatio,n.terminal.options.smoothScrollDuration=u.smoothScrolling?150:0,n.opened&&n.fitAddon.fit()})}function we(){let e=b("setting-run-as-user",""),t={defaultShell:b("setting-default-shell","Pwsh"),defaultWorkingDirectory:b("setting-working-dir",""),fontSize:parseInt(b("setting-font-size","14"),10)||14,fontFamily:b("setting-font-family","Cascadia Code"),cursorStyle:b("setting-cursor-style","bar"),cursorBlink:F("setting-cursor-blink"),theme:b("setting-theme","dark"),minimumContrastRatio:parseFloat(b("setting-contrast","1"))||1,smoothScrolling:F("setting-smooth-scrolling"),useWebGL:F("setting-webgl"),scrollbackLines:parseInt(b("setting-scrollback","10000"),10)||1e4,bellStyle:b("setting-bell-style","notification"),copyOnSelect:F("setting-copy-on-select"),rightClickPaste:F("setting-right-click-paste"),clipboardShortcuts:b("setting-clipboard-shortcuts","auto"),runAsUser:e||null,debugLogging:F("setting-debug-logging")};D("mm-theme",t.theme),fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(n=>{if(n.ok){Le(t);let o=x[t.theme]||x.dark;document.documentElement.style.setProperty("--terminal-bg",o.background),rn()}}).catch(n=>{console.error("Error saving settings:",n)})}function _n(){let e=r.settingsView;e&&(e.querySelectorAll('select, input[type="checkbox"]').forEach(t=>{t.addEventListener("change",we)}),e.querySelectorAll(".text-input-wrapper").forEach(t=>{let n=t.querySelector("input"),o=t.querySelector(".inline-save-btn");if(!n||!o)return;let i="";n.addEventListener("focus",()=>{i=n.value}),n.addEventListener("input",()=>{t.classList.toggle("unsaved",n.value!==i)}),o.addEventListener("click",()=>{we(),t.classList.remove("unsaved"),i=n.value}),n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),we(),t.classList.remove("unsaved"),i=n.value)})}))}var et=S(()=>{"use strict";O();h();L()});function On(){let e=r.app;e&&e.classList.remove("sidebar-open")}function tt(){P?Te():an()}function an(){if(ke(!0),r.settingsBtn&&r.settingsBtn.classList.add("active"),On(),c){let e=m.get(c);e&&e.container.classList.add("hidden")}r.emptyState&&r.emptyState.classList.add("hidden"),r.settingsView&&r.settingsView.classList.remove("hidden"),ne(),cn()}function Te(){if(ke(!1),r.settingsBtn&&r.settingsBtn.classList.remove("active"),r.settingsView&&r.settingsView.classList.add("hidden"),c){let e=m.get(c);e&&(e.container.classList.remove("hidden"),requestAnimationFrame(()=>{e.terminal.focus()}))}else d.length===0&&r.emptyState&&r.emptyState.classList.remove("hidden")}function ln(e){if(e<60)return e+"s";if(e<3600)return Math.floor(e/60)+"m "+e%60+"s";let t=Math.floor(e/3600),n=Math.floor(e%3600/60);return t<24?t+"h "+n+"m":Math.floor(t/24)+"d "+t%24+"h"}function nt(e){let t=document.getElementById("conhost-warning");if(!t){t=document.createElement("div"),t.id="conhost-warning",t.className="warning-banner";let o=document.querySelector(".app-header");o&&o.parentNode&&o.parentNode.insertBefore(t,o.nextSibling)}let n=e;e.conHostVersion&&n.conHostCompatible===!1?(t.innerHTML="<strong>Version mismatch:</strong> mmttyhost is "+e.conHostVersion+", expected "+n.conHostExpected+". Terminals may not work correctly. Please update mmttyhost.exe or restart the service.",t.style.display="block"):t.style.display="none"}function cn(){let e=document.getElementById("system-status-content");e&&fetch("/api/health").then(t=>t.json()).then(t=>{let n=t.healthy?"status-healthy":"status-error",o=t.healthy?"Healthy":"Unhealthy",i=ln(t.uptimeSeconds||0),s="";t.conHostVersion!==null&&t.conHostVersion!==void 0&&(s='<div class="status-detail-row"><span class="detail-label">mmttyhost</span><span class="detail-value '+(t.conHostCompatible?"":"status-error")+'">'+t.conHostVersion+(t.conHostCompatible?"":" expected "+t.conHostExpected)+"</span></div>"),e.innerHTML='<div class="status-grid"><div class="status-item"><span class="status-label">Status</span><span class="status-value '+n+'">'+o+'</span></div><div class="status-item"><span class="status-label">Mode</span><span class="status-value">'+(t.mode||"")+'</span></div><div class="status-item"><span class="status-label">Sessions</span><span class="status-value">'+t.sessionCount+'</span></div><div class="status-item"><span class="status-label">Uptime</span><span class="status-value">'+i+'</span></div></div><div class="status-details"><div class="status-detail-row"><span class="detail-label">Platform</span><span class="detail-value">'+(t.platform||"")+'</span></div><div class="status-detail-row"><span class="detail-label">Process ID</span><span class="detail-value">'+(t.webProcessId||"")+"</span></div>"+s+"</div>",nt(t)}).catch(t=>{e.innerHTML='<div class="status-error-msg">Failed to load system status: '+t.message+"</div>"})}function ot(){fetch("/api/health").then(e=>e.json()).then(e=>{nt(e),e.windowsBuildNumber!==void 0&&bt(e.windowsBuildNumber)}).catch(()=>{})}var dn=S(()=>{"use strict";h();et()});var un={};pt(un,{bindSettingsAutoSave:()=>_n,checkSystemHealth:()=>ot,closeSettings:()=>Te,fetchSettings:()=>ne,fetchSystemStatus:()=>cn,formatUptime:()=>ln,getElementChecked:()=>F,getElementValue:()=>b,openSettings:()=>an,populateSettingsForm:()=>sn,populateUserDropdown:()=>on,populateVersionInfo:()=>nn,saveAllSettings:()=>we,setElementChecked:()=>W,setElementValue:()=>y,toggleSettings:()=>tt,updateConHostWarning:()=>nt});var st=S(()=>{"use strict";dn();et()});O();h();L();function Lt(){let e=document.cookie.match(/mm-theme=([^;]+)/)?.[1];e&&x[e]&&document.documentElement.style.setProperty("--terminal-bg",x[e].background)}O();h();var kt=()=>{},Mt=()=>{},At=()=>{},Bt=()=>{},He=()=>{},It=()=>{},Rt=()=>{};function Pt(e){e.destroyTerminalForSession&&(kt=e.destroyTerminalForSession),e.applyTerminalScaling&&(Mt=e.applyTerminalScaling),e.renderSessionList&&(At=e.renderSessionList),e.updateEmptyState&&(Bt=e.updateEmptyState),e.selectSession&&(He=e.selectSession),e.updateMobileTitle&&(It=e.updateMobileTitle),e.renderUpdatePanel&&(Rt=e.renderUpdatePanel)}function ge(){let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/state`);ht(t),t.onopen=()=>{Ae(X),Be(!0),Z()},t.onmessage=n=>{try{let o=JSON.parse(n.data),i=o.sessions?.sessions??[];Tn(i),Cn(o.update)}catch(o){console.error("Error parsing state:",o)}},t.onclose=()=>{Be(!1),Z(),Ln()},t.onerror=n=>{console.error("State WebSocket error:",n)}}function Tn(e){let t=new Set(e.map(n=>n.id));m.forEach((n,o)=>{t.has(o)||(kt(o),V.delete(o))}),e.forEach(n=>{let o=m.get(n.id);o&&o.opened?(o.serverCols!==n.cols||o.serverRows!==n.rows)&&(o.serverCols=n.cols,o.serverRows=n.rows,o.terminal.resize(n.cols,n.rows),Mt(n.id,o)):o&&(o.serverCols=n.cols,o.serverRows=n.rows)}),ft(e),At(),Bt(),!c&&d.length>0&&He(d[0].id),c&&!d.find(n=>n.id===c)&&(J(null),d.length>0&&He(d[0].id)),It()}function Cn(e){me(e),Rt()}function Ln(){le!==void 0&&clearTimeout(le);let e=ce,t=window.setTimeout(()=>{Ae(Math.min(ce*1.5,re)),ge()},e);vt(t)}function Z(){let e=document.getElementById("connection-status");if(!e)return;let t,n;z&&H?(t="connected",n=""):!z&&!H?(t="disconnected",n="Server disconnected"):(t="reconnecting",n="Reconnecting..."),e.className=`connection-status ${t}`,e.textContent=n}O();h();var Ht=()=>{},Nt=()=>{};function Dt(e){e.applyTerminalScaling&&(Ht=e.applyTerminalScaling),e.refreshActiveTerminalBuffer&&(Nt=e.refreshActiveTerminalBuffer)}function he(){let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/mux`);t.binaryType="arraybuffer",St(t),t.onopen=()=>{let n=Y>X;Ie(X),Re(!0),Z(),n&&Nt()},t.onmessage=n=>{if(!(n.data instanceof ArrayBuffer))return;let o=new Uint8Array(n.data);if(o.length<9)return;let i=o[0],s=In(o,1),l=o.slice(9);if(i===5){console.log("[Resync] Clearing terminals for buffer refresh"),m.forEach(a=>{a.opened&&a.terminal.clear()}),C.clear();return}if(i===1){let a=m.get(s);a&&a.opened&&l.length>=4?Pn(s,a,l):l.length>=4&&(C.has(s)||C.set(s,[]),C.get(s).push(l.slice()))}},t.onclose=()=>{Re(!1),Z(),Rn()},t.onerror=n=>{console.error("Mux WebSocket error:",n)}}function Ne(e,t){if(!A||A.readyState!==WebSocket.OPEN)return;let n=new TextEncoder().encode(t),o=new Uint8Array(9+n.length);o[0]=2,Wt(o,1,e),o.set(n,9),A.send(o)}function Ut(e,t,n){if(!A||A.readyState!==WebSocket.OPEN)return;let o=new Uint8Array(13);o[0]=3,Wt(o,1,e),o[9]=t&255,o[10]=t>>8&255,o[11]=n&255,o[12]=n>>8&255,A.send(o);let i=m.get(e);i&&(i.serverCols=t,i.serverRows=n)}function Wt(e,t,n){for(let o=0;o<8;o++)e[t+o]=o<n.length?n.charCodeAt(o):0}function In(e,t){let n=[];for(let o=0;o<8;o++)e[t+o]!==0&&n.push(String.fromCharCode(e[t+o]));return n.join("")}function Rn(){de!==void 0&&clearTimeout(de);let e=Y,t=window.setTimeout(()=>{Ie(Math.min(Y*1.5,re)),he()},e);yt(t)}function Pn(e,t,n){let o=n[0]|n[1]<<8,i=n[2]|n[3]<<8,s=n.slice(4),l=o>0&&o<=500&&i>0&&i<=500,a=t.terminal._core;if(l&&a&&a._renderService){let p=t.terminal.cols,g=t.terminal.rows;if(p!==o||g!==i)try{t.terminal.resize(o,i),t.serverCols=o,t.serverRows=i,Ht(e,t)}catch(v){console.warn("Terminal resize deferred:",v.message)}}s.length>0&&t.terminal.write(s)}Ze();h();var E=null;function jt(e){E=e}function U(e){return e.name||e.shellType}function $(){if(!r.sessionList)return;r.sessionList.innerHTML="",d.forEach(t=>{let n=N.has(t.id),o=document.createElement("div");o.className="session-item"+(t.id===c?" active":"")+(n?" pending":""),o.dataset.sessionId=t.id,n||o.addEventListener("click",()=>{E&&(E.onSelect(t.id),E.onCloseSidebar())});let i=document.createElement("div");if(i.className="session-info",n){let a=document.createElement("span");a.className="session-spinner",i.appendChild(a)}let s=document.createElement("span");s.className="session-title",s.textContent=U(t),i.appendChild(s);let l=document.createElement("div");if(l.className="session-actions",!n){let a=document.createElement("button");a.className="session-resize",a.innerHTML="\u2922",a.title="Fit to screen",a.addEventListener("click",v=>{v.stopPropagation(),E&&E.onResize(t.id)});let p=document.createElement("button");p.className="session-rename",p.innerHTML="\u270F\uFE0F",p.title="Rename session",p.addEventListener("click",v=>{v.stopPropagation(),E&&E.onRename(t.id)});let g=document.createElement("button");g.className="session-close",g.innerHTML="&times;",g.title="Close session",g.addEventListener("click",v=>{v.stopPropagation(),E&&E.onDelete(t.id)}),l.appendChild(a),l.appendChild(p),l.appendChild(g)}o.appendChild(i),o.appendChild(l),r.sessionList.appendChild(o)});let e=d.filter(t=>!N.has(t.id)).length;r.sessionCount&&(r.sessionCount.textContent=String(e))}function be(){r.emptyState&&(d.length===0?(r.emptyState.classList.remove("hidden"),r.settingsView&&r.settingsView.classList.add("hidden")):P||r.emptyState.classList.add("hidden"))}function xe(){if(!r.mobileTitle)return;let e=d.find(t=>t.id===c);r.mobileTitle.textContent=e?U(e):"MiddleManager",r.topbarActions&&(e?r.topbarActions.classList.remove("no-terminal"):r.topbarActions.classList.add("no-terminal")),r.islandTitle&&(r.islandTitle.textContent=e?U(e):"MiddleManager")}h();L();var Qe="mm-sidebar-collapsed",Xt="mm-sidebar-width",Wn=768,Yt=180,Gt=400;function Jt(){Me(!ae),r.app&&r.app.classList.toggle("sidebar-open",ae)}function Ee(){Me(!1),r.app&&r.app.classList.remove("sidebar-open")}function Zt(){pe(!0),r.app&&r.app.classList.add("sidebar-collapsed"),D(Qe,"true"),Fn()}function Qt(){pe(!1),r.app&&r.app.classList.remove("sidebar-collapsed"),D(Qe,"false")}function Fn(){if(!r.islandTitle)return;let e=d.find(t=>t.id===c);r.islandTitle.textContent=e?U(e):"MiddleManager"}function en(){Pe(Qe)==="true"&&window.innerWidth>Wn&&(pe(!0),r.app&&r.app.classList.add("sidebar-collapsed"));let e=Pe(Xt);if(e){let t=parseInt(e,10);if(t>=Yt&&t<=Gt){let n=document.getElementById("sidebar");n&&(n.style.width=t+"px")}}}function tn(){let e=document.getElementById("sidebar-resize-grip"),t=document.getElementById("sidebar");if(!e||!t)return;let n=!1,o=0,i=0;e.addEventListener("mousedown",s=>{n=!0,o=s.clientX,i=t.offsetWidth,e.classList.add("active"),document.body.style.cursor="ew-resize",document.body.style.userSelect="none",s.preventDefault()}),document.addEventListener("mousemove",s=>{if(!n)return;let l=s.clientX-o,a=Math.max(Yt,Math.min(Gt,i+l));t.style.width=a+"px"}),document.addEventListener("mouseup",()=>{if(!n)return;n=!1,e.classList.remove("active"),document.body.style.cursor="",document.body.style.userSelect="";let s=t.offsetWidth;D(Xt,String(s))})}st();h();async function oe(){try{let e=await fetch("/api/auth/status");if(e.status===401){window.location.href="/login.html";return}let t=await e.json();gt(t),mn(),pn()}catch(e){console.error("Auth status error:",e)}}function mn(){let e=document.getElementById("security-warning");e&&(T&&T.authenticationEnabled&&!T.passwordSet?e.classList.remove("hidden"):e.classList.add("hidden"))}function pn(){let e=document.getElementById("password-status-text");if(e){if(!T){e.textContent="Checking...",e.className="";return}T.passwordSet?(e.textContent="Password is set",e.className="status-set"):(e.textContent="No password set",e.className="status-missing")}}function it(){let e=document.getElementById("security-warning");e&&e.classList.add("hidden")}h();L();var se=!1;function rt(e){let t=document.getElementById("password-modal"),n=document.getElementById("password-modal-title"),o=document.getElementById("current-password-group"),i=document.getElementById("password-error");if(!t)return;se=T?.passwordSet??!1,n&&(n.textContent=se?"Change Password":"Set Password"),o&&(o.style.display=se?"block":"none"),i&&(i.classList.add("hidden"),i.textContent="");let s=document.getElementById("password-form");s&&s.reset(),t.classList.remove("hidden");let l=se?"current-password":"new-password",a=document.getElementById(l);a&&a.focus()}function ie(){let e=document.getElementById("password-modal");e&&e.classList.add("hidden")}function fn(e){e.preventDefault();let t=document.getElementById("current-password"),n=document.getElementById("new-password"),o=document.getElementById("confirm-password"),i=document.getElementById("btn-save-password"),s=n?.value??"",l=o?.value??"";if(!s){j("New password is required");return}if(s!==l){j("Passwords do not match");return}if(s.length<4){j("Password must be at least 4 characters");return}let a={currentPassword:se&&t?t.value:null,newPassword:s};i&&(i.disabled=!0,i.textContent="Saving..."),fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(p=>p.json().then(g=>({ok:p.ok,data:g}))).then(p=>{i&&(i.disabled=!1,i.textContent="Save"),p.ok&&p.data.success?(ie(),oe()):j(p.data.error||"Failed to change password")}).catch(()=>{i&&(i.disabled=!1,i.textContent="Save"),j("Connection error")})}function j(e){let t=document.getElementById("password-error");t&&(t.textContent=e,t.classList.remove("hidden"))}function at(){f("btn-set-password-warning",()=>{rt(!0)}),f("btn-dismiss-warning",it),f("btn-change-password",()=>{rt(!1)}),f("btn-close-password",ie),f("btn-cancel-password",ie);let e=document.querySelector("#password-modal .modal-backdrop");e&&e.addEventListener("click",ie);let t=document.getElementById("password-form");t&&t.addEventListener("submit",fn)}h();var gn=30,hn=2e3,zn=3e3;function lt(){let e=document.getElementById("update-panel");if(!e)return;if(!w||!w.available){e.classList.add("hidden");return}e.classList.remove("hidden");let t=e.querySelector(".update-current"),n=e.querySelector(".update-latest"),o=e.querySelector(".update-note"),i=e.querySelector(".update-header");t&&(t.textContent=w.currentVersion),n&&(n.textContent=w.latestVersion),w.sessionsPreserved?(i&&(i.textContent="Quick Update"),o&&(o.textContent="Sessions will stay alive",o.classList.add("update-note-safe"),o.classList.remove("update-note-warning"))):(i&&(i.textContent="Update Available"),o&&(o.textContent="Save your work - sessions will restart",o.classList.add("update-note-warning"),o.classList.remove("update-note-safe")))}function ct(){if(!w||!w.available)return;let t=document.getElementById("update-panel")?.querySelector(".update-btn");t&&(t.disabled=!0,t.textContent="Updating..."),fetch("/api/update/apply",{method:"POST"}).then(n=>{n.ok?(t&&(t.textContent="Restarting..."),Vn()):(t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update failed"))}).catch(n=>{t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update error:",n)})}function Vn(){let e=0;function t(){e++,fetch("/api/version",{cache:"no-store"}).then(n=>{n.ok?location.reload():e<gn&&setTimeout(t,hn)}).catch(()=>{e<gn&&setTimeout(t,hn)})}setTimeout(t,zn)}function vn(){let e=document.getElementById("btn-check-updates"),t=document.getElementById("update-status");e&&(e.disabled=!0,e.textContent="Checking..."),fetch("/api/update/check").then(n=>n.json()).then(n=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),me(n),lt();let o=document.getElementById("btn-apply-update");if(t)if(t.classList.remove("hidden"),n&&n.available){t.className="update-status update-status-available";let i="Update available: v"+n.latestVersion;n.sessionsPreserved?i+=" (sessions will stay alive)":i+=" (sessions will restart)",t.textContent=i,o&&o.classList.remove("hidden")}else t.className="update-status update-status-current",t.textContent="You are running the latest version",o&&o.classList.add("hidden")}).catch(n=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),t&&(t.classList.remove("hidden"),t.className="update-status update-status-error",t.textContent="Failed to check for updates"),console.error("Update check error:",n)})}L();var qn="https://api.github.com/repos/AiTlbx/MiddleManager/releases?per_page=10",Kn="https://github.com/AiTlbx/MiddleManager/releases";function Sn(){let e=document.getElementById("changelog-modal"),t=document.getElementById("changelog-body");e&&e.classList.remove("hidden"),t&&(t.innerHTML='<div class="changelog-loading">Loading changelog...</div>'),fetch(qn).then(n=>n.json()).then(n=>{if(!t)return;if(!n||n.length===0){t.innerHTML="<p>No releases found.</p>";return}let o="";n.forEach(i=>{let s=i.tag_name||"Unknown",l=i.published_at?new Date(i.published_at).toLocaleDateString():"",a=i.body||"No release notes.";o+='<div class="changelog-release">',o+='<div class="changelog-version">'+B(s)+"</div>",l&&(o+='<div class="changelog-date">'+B(l)+"</div>"),o+='<div class="changelog-notes">'+$n(a)+"</div>",o+="</div>"}),t.innerHTML=o}).catch(n=>{t&&(t.innerHTML='<p class="changelog-error">Failed to load changelog. <a href="'+Kn+'" target="_blank">View on GitHub</a></p>'),console.error("Changelog error:",n)})}function dt(){let e=document.getElementById("changelog-modal");e&&e.classList.add("hidden")}function $n(e){return B(e).replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}h();L();window.mmDebug={get terminals(){return m},get activeId(){return c},get settings(){return u}};Lt();document.addEventListener("DOMContentLoaded",jn);function jn(){xt(),en(),tn();let e=Je();fe(e),Xn(),ge(),he(),ot(),no(),at(),Ke(),Ue(),We(),eo(),to(),ne(),oe(),Zn(),Yn()}function Xn(){Pt({destroyTerminalForSession:Se,applyTerminalScaling:I,renderSessionList:$,updateEmptyState:be,selectSession:Ce,updateMobileTitle:xe,renderUpdatePanel:lt}),Dt({applyTerminalScaling:I,refreshActiveTerminalBuffer:ye}),Xe({sendInput:Ne,showBellNotification:Qn}),De({sendResize:(e,t)=>{Ut(e,t.cols,t.rows)}}),jt({onSelect:Ce,onDelete:yn,onRename:Gn,onResize:Q,onCloseSidebar:Ee})}function Yn(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(z||ge(),H||he(),H&&c&&setTimeout(ye,200))})}function ut(){let e=r.terminalsArea?.getBoundingClientRect(),t=u?.defaultCols??120,n=u?.defaultRows??30;if(e&&e.width>100&&e.height>100){let s=u?.fontSize??14,l=s*.6,a=s*1.2,p=8,g=e.width-p,v=e.height-p,_=Math.floor(g/l),mt=Math.floor(v/a);_>10&&mt>5&&(t=Math.min(_,300),n=Math.min(mt,100))}let o="pending-"+Date.now(),i={id:o,name:null,shellType:"Loading...",cols:t,rows:n};d.push(i),N.add(o),$(),Ee(),fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Cols:t,Rows:n})}).then(s=>s.json()).then(s=>{N.delete(o);let l=d.findIndex(a=>a.id===o);l>=0&&d.splice(l,1),V.add(s.id),Ce(s.id)}).catch(s=>{N.delete(o);let l=d.findIndex(a=>a.id===o);l>=0&&(d.splice(l,1),$(),be()),console.error("Error creating session:",s)})}function Ce(e){P&&Te(),m.forEach(s=>{s.container.classList.add("hidden")}),J(e);let t=d.find(s=>s.id===e),n=Ge(e,t),o=n.serverCols===0,i=V.has(e);n.container.classList.remove("hidden"),requestAnimationFrame(()=>{n.terminal.focus(),o&&!i&&Promise.resolve().then(()=>(Ze(),$t)).then(s=>{s.fetchAndWriteBuffer(e,n.terminal)}),i&&V.delete(e)}),$(),xe(),r.emptyState?.classList.add("hidden")}function yn(e){Se(e);let t=d.findIndex(n=>n.id===e);t>=0&&d.splice(t,1),c===e&&(J(null),d.length>0&&Ce(d[0].id)),$(),be(),xe(),fetch("/api/sessions/"+e,{method:"DELETE"}).catch(n=>{console.error("Error deleting session:",n)})}function bn(e,t){let n=d.find(s=>s.id===e);if(!n)return;let o=(t||"").trim(),i=o===""||o===n.shellType?null:o;fetch("/api/sessions/"+e+"/name",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i})}).then(()=>{n.manuallyNamed=!0}).catch(s=>{console.error("Error renaming session:",s)})}function Gn(e){let t=r.sessionList?.querySelector(`[data-session-id="${e}"]`);if(!t)return;let n=t.querySelector(".session-title");if(!n)return;let o=d.find(a=>a.id===e),i=o?o.name||o.shellType:"",s=document.createElement("input");s.type="text",s.className="session-rename-input",s.value=i;function l(){bn(e,s.value),s.replaceWith(n)}s.addEventListener("blur",l),s.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),s.blur()):a.key==="Escape"&&(a.preventDefault(),s.replaceWith(n))}),n.replaceWith(s),s.focus(),s.select()}function Jn(e){let t=d.find(i=>i.id===e);if(!t)return;let n=t.name||t.shellType,o=prompt("Rename terminal:",n);o!==null&&bn(e,o)}function Zn(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().catch(()=>{})}function Qn(e){if(!u)return;let t=u.bellStyle||"notification",n=d.find(i=>i.id===e),o=n?U(n):"Terminal";if((t==="notification"||t==="both")&&Notification.permission==="granted"&&document.hidden&&new Notification("Bell: "+o,{body:"Terminal bell triggered",icon:"/favicon.ico"}),t==="visual"||t==="both"){let i=m.get(e);i&&(i.container.classList.add("bell-flash"),setTimeout(()=>{i.container.classList.remove("bell-flash")},200))}}function eo(){fetch("/api/version").then(e=>e.text()).then(e=>{let t=e.split(/[+-]/)[0].split(".").slice(0,3).join("."),n=document.getElementById("app-version");n&&(n.textContent="v"+t)}).catch(()=>{})}function to(){fetch("/api/networks").then(e=>e.json()).then(e=>{let t=document.getElementById("network-list");t&&(t.innerHTML=e.map(n=>'<div class="network-item"><span class="network-name" title="'+B(n.name)+'">'+B(n.name)+'</span><span class="network-ip">'+B(n.ip)+":"+location.port+"</span></div>").join(""))}).catch(()=>{})}function no(){f("btn-new-session",ut),f("btn-new-session-mobile",ut),f("btn-create-terminal",ut),f("btn-hamburger",Jt),f("btn-collapse-sidebar",Zt),f("btn-expand-sidebar",Qt),r.sidebarOverlay&&r.sidebarOverlay.addEventListener("click",Ee),f("btn-ctrlc-mobile",()=>{c&&Ne(c,"")}),f("btn-resize-mobile",()=>{c&&Q(c)}),f("btn-rename-mobile",()=>{c&&Jn(c)}),f("btn-close-mobile",()=>{c&&yn(c)}),r.settingsBtn&&r.settingsBtn.addEventListener("click",tt),f("update-btn",ct),f("btn-check-updates",vn),f("btn-apply-update",ct),f("btn-show-changelog",Sn),f("btn-close-changelog",dt);let e=document.querySelector("#changelog-modal .modal-backdrop");e&&e.addEventListener("click",dt),Promise.resolve().then(()=>(st(),un)).then(t=>{t.bindSettingsAutoSave()})}})();
