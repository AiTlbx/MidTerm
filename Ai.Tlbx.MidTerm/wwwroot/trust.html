<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Trust Certificate - MidTerm</title>

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#1e1e1e" />

    <link rel="stylesheet" href="css/app.css" />
</head>
<body class="trust-page">
    <div class="trust-container">
        <div class="trust-header">
            <h1>Trust This Server</h1>
            <p>MidTerm Terminal Multiplexer</p>
        </div>

        <!-- Fingerprint verification (prominent) -->
        <section class="trust-section fingerprint-section">
            <h2>Step 1: Verify Fingerprint</h2>
            <div class="fingerprint-box">
                <div class="fingerprint-display" id="fingerprint">Loading...</div>
                <button type="button" class="copy-btn" id="copy-fingerprint" title="Copy to clipboard">Copy</button>
            </div>
            <div class="trust-hint">
                <strong>Security check:</strong> Compare this fingerprint with the one shown during installation
                or on your original trusted device. If they match, this connection is authentic.
            </div>
        </section>

        <!-- Platform-specific instructions -->
        <section class="trust-section platform-section">
            <h2>Step 2: Install Certificate</h2>
            <p class="platform-detected">Detected: <span id="detected-platform">Unknown</span></p>

            <!-- iOS panel -->
            <div id="ios-panel" class="platform-panel hidden">
                <h3>iOS / iPadOS</h3>
                <button type="button" class="install-btn" id="btn-install-ios">
                    Install Profile
                </button>
                <ol class="install-steps">
                    <li>Tap "Install Profile" above</li>
                    <li>Open <strong>Settings</strong> app</li>
                    <li>Tap <strong>Profile Downloaded</strong> (near the top)</li>
                    <li>Tap <strong>Install</strong>, enter passcode if prompted</li>
                    <li>Go to <strong>Settings &rarr; General &rarr; About &rarr; Certificate Trust Settings</strong></li>
                    <li>Enable full trust for <strong>MidTerm Certificate</strong></li>
                </ol>
            </div>

            <!-- Android panel -->
            <div id="android-panel" class="platform-panel hidden">
                <h3>Android</h3>
                <button type="button" class="install-btn" id="btn-install-android">
                    Download Certificate
                </button>
                <ol class="install-steps">
                    <li>Tap "Download Certificate" above</li>
                    <li>Open <strong>Settings &rarr; Security &rarr; Encryption & credentials</strong></li>
                    <li>Tap <strong>Install a certificate &rarr; CA certificate</strong></li>
                    <li>Select the downloaded <code>midterm.pem</code> file</li>
                    <li>Verify the fingerprint shown matches the one above</li>
                </ol>
                <p class="install-note">Note: Menu names vary by Android version and manufacturer.</p>
            </div>

            <!-- Desktop panel -->
            <div id="desktop-panel" class="platform-panel hidden">
                <h3>Desktop</h3>
                <div class="os-tabs">
                    <button type="button" class="os-tab active" data-os="windows">Windows</button>
                    <button type="button" class="os-tab" data-os="macos">macOS</button>
                    <button type="button" class="os-tab" data-os="linux">Linux</button>
                </div>

                <div class="os-instructions" id="windows-instructions">
                    <p>Run as Administrator in PowerShell:</p>
                    <code class="command-block">certutil -addstore Root "<span id="cert-path-win">C:\ProgramData\MidTerm\midterm.pem</span>"</code>
                    <p>Or download and install manually:</p>
                    <button type="button" class="install-btn secondary" id="btn-download-pem-desktop">
                        Download Certificate
                    </button>
                </div>

                <div class="os-instructions hidden" id="macos-instructions">
                    <p>Run in Terminal:</p>
                    <code class="command-block">sudo security add-trusted-cert -d -r trustRoot \
    -k /Library/Keychains/System.keychain midterm.pem</code>
                    <button type="button" class="install-btn secondary" id="btn-download-pem-macos">
                        Download Certificate
                    </button>
                </div>

                <div class="os-instructions hidden" id="linux-instructions">
                    <p>Run in Terminal:</p>
                    <code class="command-block">sudo cp midterm.pem /usr/local/share/ca-certificates/midterm.crt
sudo update-ca-certificates</code>
                    <button type="button" class="install-btn secondary" id="btn-download-pem-linux">
                        Download Certificate
                    </button>
                </div>
            </div>
        </section>

        <!-- Browser verification education -->
        <section class="trust-section education-section">
            <h2>Verify in Your Browser</h2>
            <p>After installing, verify the connection is secure:</p>
            <ol class="install-steps">
                <li>Click the <strong>padlock icon</strong> in your browser's address bar</li>
                <li>Click <strong>Certificate</strong> or <strong>Connection is secure</strong></li>
                <li>Find the <strong>SHA-256 fingerprint</strong></li>
                <li>Compare it with the fingerprint shown above</li>
            </ol>
            <div class="warning-box">
                <strong>Security Warning:</strong> Never enter passwords or sensitive information
                until you have verified the fingerprint matches. If your browser shows a certificate
                warning after previously working, re-verify the fingerprint before proceeding.
            </div>
        </section>

        <!-- Connection info -->
        <section class="trust-section endpoints-section">
            <h2>Available Endpoints</h2>
            <div id="endpoints-list" class="endpoints-list">
                <p>Loading...</p>
            </div>
            <div class="cert-validity">
                <span id="cert-valid-until"></span>
            </div>
        </section>

        <div class="trust-footer">
            <a href="/" class="back-link">&larr; Back to MidTerm</a>
        </div>
    </div>

    <script>
        (function() {
            // Platform detection
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /android/.test(ua);
            const isMac = /macintosh|mac os x/.test(ua) && !isIOS;
            const isWindows = /windows/.test(ua);
            const isLinux = /linux/.test(ua) && !isAndroid;

            const detectedPlatformEl = document.getElementById('detected-platform');
            const iosPanel = document.getElementById('ios-panel');
            const androidPanel = document.getElementById('android-panel');
            const desktopPanel = document.getElementById('desktop-panel');

            if (isIOS) {
                detectedPlatformEl.textContent = 'iOS / iPadOS';
                iosPanel.classList.remove('hidden');
            } else if (isAndroid) {
                detectedPlatformEl.textContent = 'Android';
                androidPanel.classList.remove('hidden');
            } else {
                if (isMac) {
                    detectedPlatformEl.textContent = 'macOS';
                    showDesktopTab('macos');
                } else if (isLinux) {
                    detectedPlatformEl.textContent = 'Linux';
                    showDesktopTab('linux');
                } else {
                    detectedPlatformEl.textContent = 'Windows';
                    showDesktopTab('windows');
                }
                desktopPanel.classList.remove('hidden');
            }

            // Desktop OS tabs
            document.querySelectorAll('.os-tab').forEach(tab => {
                tab.addEventListener('click', () => showDesktopTab(tab.dataset.os));
            });

            function showDesktopTab(os) {
                document.querySelectorAll('.os-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.os-tab[data-os="${os}"]`).classList.add('active');

                document.querySelectorAll('.os-instructions').forEach(el => el.classList.add('hidden'));
                document.getElementById(`${os}-instructions`).classList.remove('hidden');
            }

            // Download buttons
            document.getElementById('btn-install-ios').addEventListener('click', () => {
                window.location.href = '/api/certificate/download/mobileconfig';
            });

            document.getElementById('btn-install-android').addEventListener('click', () => {
                window.location.href = '/api/certificate/download/pem';
            });

            document.getElementById('btn-download-pem-desktop').addEventListener('click', () => {
                window.location.href = '/api/certificate/download/pem';
            });
            document.getElementById('btn-download-pem-macos').addEventListener('click', () => {
                window.location.href = '/api/certificate/download/pem';
            });
            document.getElementById('btn-download-pem-linux').addEventListener('click', () => {
                window.location.href = '/api/certificate/download/pem';
            });

            // Copy fingerprint
            document.getElementById('copy-fingerprint').addEventListener('click', async () => {
                const fp = document.getElementById('fingerprint').textContent;
                try {
                    await navigator.clipboard.writeText(fp);
                    const btn = document.getElementById('copy-fingerprint');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                } catch (err) {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = fp;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
            });

            // Load certificate info
            loadCertificateInfo();

            async function loadCertificateInfo() {
                try {
                    const response = await fetch('/api/certificate/share-packet');
                    if (!response.ok) return;

                    const info = await response.json();

                    // Display fingerprint
                    document.getElementById('fingerprint').textContent = info.certificate.fingerprintFormatted;

                    // Display validity
                    const validUntil = new Date(info.certificate.notAfter);
                    document.getElementById('cert-valid-until').textContent =
                        'Certificate valid until: ' + validUntil.toLocaleDateString(undefined, {
                            year: 'numeric', month: 'long', day: 'numeric'
                        });

                    // Display endpoints
                    const endpointsList = document.getElementById('endpoints-list');
                    if (info.endpoints && info.endpoints.length > 0) {
                        endpointsList.innerHTML = info.endpoints.map(ep =>
                            `<div class="endpoint-item">
                                <span class="endpoint-name">${ep.name}</span>
                                <a href="${ep.url}" class="endpoint-url">${ep.url}</a>
                            </div>`
                        ).join('');
                    } else {
                        endpointsList.innerHTML = '<p>No network endpoints available</p>';
                    }
                } catch (err) {
                    document.getElementById('fingerprint').textContent = 'Error loading certificate info';
                }
            }
        })();
    </script>
</body>
</html>
